#!/usr/bin/env zsh

# convert jupyter notebooks into executable python and adds hashbang

TEMPLATE=`mktemp`

# create the template and remove any Jupyter Notebook magic commands
# see: https://github.com/ipython/ipython/issues/3707

## Comments out magic statement
##{% block codecell %}
##{{  super().replace('get_ipython','#get_ipython') if "get_ipython" in super() else super() }}
##{% endblock codecell %}


cat <<EOT >> $TEMPLATE
{% extends "python.tpl"%}
## set to python3
{%- block header -%}
#!/usr/bin/env python3
# coding: utf-8
{% endblock header %}

## remove markdown cells entirely
{% block markdowncell %}
{% endblock markdowncell %}

## remove cell execution count entirely
{% block in_prompt %}
{% endblock in_prompt %}


## remove magic statement completely
{% block codecell %}
{{'' if "get_ipython" in super() else super() }}
{% endblock codecell%}
EOT


echo converting $1 to ${1:r}.py
echo "********** #!/usr/bin/env python3 **********"

# check for a supplied file
if [[ $1 != "" ]];
then
  if [[ $2 != "" ]];
  then
    outpath=$2
  else
    outpath='./'
  fi

  filename=$(basename -- $1)
  extension="${filename##*.}"
  filename="${filename%.*}"

  jupyter nbconvert --to python $1 --stdout --template=$TEMPLATE > $outpath/$filename.py

else
  echo "converts ipython notebooks directly to executable python .py scripts"
  echo "error: no .ipynb specified"
  echo "$0 [NOTEBOOK File] [optional: output path]"
  echo "usage: $ nbconvert my_notebook.ipynb "
fi
